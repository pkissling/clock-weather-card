name: Sync icons

on:
  push:
    # branches:
    #   - master
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for proper diff detection

    - name: Clone source repository
      uses: actions/checkout@v4
      with:
        repository: basmilius/weather-icons
        path: weather-icons-source

    - name: Synchronize directories
      run: |
        mkdir -p src/icons/
        rsync -av --delete --exclude='.git/' \
          weather-icons-source/production/ \
          src/icons/ 
      shell: bash

    - name: Remove source repository traces
      run: |
        rm -rf weather-icons-source
        git ls-files -z | xargs -0 git update-index --assume-unchanged

    - name: Commit and create pull request
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GH_PAT }}
        branch: sync/weather-icons-$(date +%s)
        commit-message: "chore: Synchronize weather icons from basmilius/weather-icons" 
        title: "Icon Sync"
        body: |
          Automated synchronization from:
          - Source: `production/` in basmilius/weather-icons
          - Target: `src/icons/` in current repository
          
          Changes include:
          - Recursive directory synchronization
          - File additions/removals based on source state
